{"version":3,"sources":["webpack://reaction-diffusion-webgl/./src/ts/engine.ts","webpack://reaction-diffusion-webgl/./src/ts/enums.ts","webpack://reaction-diffusion-webgl/./src/ts/fps-indicator.ts","webpack://reaction-diffusion-webgl/./src/ts/gl-utils/gl-canvas.ts","webpack://reaction-diffusion-webgl/./src/ts/gl-utils/gl-resource.ts","webpack://reaction-diffusion-webgl/./src/ts/gl-utils/shader-manager.ts","webpack://reaction-diffusion-webgl/./src/ts/gl-utils/shader-sources.ts","webpack://reaction-diffusion-webgl/./src/ts/gl-utils/shader.ts","webpack://reaction-diffusion-webgl/./src/ts/gl-utils/vbo.ts","webpack://reaction-diffusion-webgl/./src/ts/input-image.ts","webpack://reaction-diffusion-webgl/./src/ts/loader.ts","webpack://reaction-diffusion-webgl/./src/ts/main.ts","webpack://reaction-diffusion-webgl/./src/ts/parameters.ts","webpack://reaction-diffusion-webgl/./src/ts/presets.ts","webpack://reaction-diffusion-webgl/./src/ts/texture/image-texture.ts","webpack://reaction-diffusion-webgl/./src/ts/texture/render-to-texture-swapable.ts","webpack://reaction-diffusion-webgl/./src/ts/texture/render-to-texture.ts","webpack://reaction-diffusion-webgl/./src/ts/visor.ts","webpack://reaction-diffusion-webgl/webpack/bootstrap","webpack://reaction-diffusion-webgl/webpack/startup"],"names":["isInRange","min","max","x","lastUpdateTimestamp","targetWidth","targetHeight","this","squareVBO","VBO","createQuad","gl","greyscaleTexture","ImageTexture","loadFromUrl","colorscaleTexture","internalTextures","RenderToTextureSwapable","needToReset","lastIterationUpdate","performance","now","iteration","asyncLoadShader","shader","displayMonochromeShader","displayTricolorShader","displayRampShader","updateUniformShader","updateMapShader","A_FEEDING_MIN","Engine","toFixed","A_FEEDING_MAX","B_KILLING_MIN","B_KILLING_MAX","updateImageMapShader","resetShader","brushApplyShader","brushDisplayShader","resize","width","height","reset","drawToCanvas","viewport","displayMode","Parameters","EDisplayMode","MONOCHROME","shading","EShading","BINARY","u","value","current","GREYSCALE","id","TRICOLOR","parametersMap","EParametersMap","IMAGE","canvasAspectRatio","internalTextureAspectRatio","zoom","bindFramebuffer","FRAMEBUFFER","use","bindUniformsAndAttributes","drawArrays","TRIANGLE_STRIP","update","adjustInternalTextureSize","clearInternalTextures","handleBrush","nbIterations","computeNbIterationsForThisFrame","map","inputImageTexture","InputImage","getTexture","patternsScale","bindAttributes","updateInternal","splitNbIterations","Math","ceil","updateShader","UNIFORM","AFeedingRate","BKillingRate","ADiffusionRate","BDIffusionRate","VALUE_PICKING","texture","i","swap","currentFramebuffer","previous","bindUniforms","_iteration","displayBrush","size","brushSize","mousePosition","Page","Canvas","getMousePosition","isMouseDown","position","pattern","initialState","EInitialState","BLANK","DISC","CIRCLE","neededWidth","neededHeight","imageAspectRatio","reserveSpace","setIndicatorText","toString","nbIterationsPerFrameAt60FPS","speed","instantFPS","name","vertexFilename","fragmentFilename","callback","injected","Loader","registerLoadingObject","ShaderManager","buildShader","builtShader","registerLoadedObject","a","Demopage","setErrorMessage","framesSinceLastFPSUpdate","timeOfLastFPSUpdate","setInterval","fps","round","registerFrame","initGL","flags","setError","message","canvas","getCanvas","getContext","disable","CULL_FACE","DEPTH_TEST","BLEND","clearColor","adjustSize","hidpi","cssPixel","window","devicePixelRatio","floor","clientWidth","clientHeight","_gl","GLResource","cachedShaders","infos","sourcesPending","sourcesFailed","loadedSource","success","processSource","source","replace","match","vert","ShaderSources","getSource","frag","processedVert","processedFrag","Shader","loadSource","getShader","registerShader","callAndClearCallbacks","cached","callbacks","cachedCallback","failed","pending","push","deleteShader","freeGLResources","cachedSources","filename","text","url","version","XMLHttpRequest","open","onload","readyState","status","responseText","console","error","statusText","onerror","send","notImplemented","alert","types","str","binder","location","uniform2fv","uniform3fv","uniform4fv","uniform2iv","uniform3iv","uniform4iv","uniform1i","uniformMatrix2fv","uniformMatrix3fv","uniformMatrix4fv","unitNb","activeTexture","bindTexture","TEXTURE_2D","TEXTURE_CUBE_MAP","Array","isArray","uniform1iv","uniform1fv","uniform1f","vertexSource","fragmentSource","createShader","type","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","log","uCount","aCount","vertexShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","introspection","getProgramInfoLog","deleteProgram","useProgram","currTextureUnitNb","Object","keys","forEach","uName","uniform","loc","aName","attribute","bind","ACTIVE_UNIFORMS","getActiveUniform","getUniformLocation","ACTIVE_ATTRIBUTES","getActiveAttrib","getAttribLocation","Usage","array","staticUsage","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","STATIC_DRAW","DYNAMIC_DRAW","normalize","stride","offset","usage","STATIC","DYNAMIC","minX","minY","maxX","maxY","Float32Array","FLOAT","deleteBuffer","enableVertexAttribArray","vertexAttribPointer","setData","currentImageData","hiddenCanvas","document","createElement","hiddenCanvasContext","currentTexture","computeBrightness","r","g","b","imageUploadObservers","image","scalingFactor","finalWidth","finalHeight","drawImage","imageData","getImageData","rawDataCopy","Uint8ClampedArray","data","iY","iX","brightness","downsizeImageIfNeeded","uploadToGPU","loadingObjects","length","showLoader","updateBlur","blur","style","filter","GLCanvas","alpha","antialias","depth","stencil","preserveDrawingBuffer","STENCIL_TEST","blurChangeObservers","needToAdjustCanvasSize","canvasResizeObservers","resetObservers","needToDownload","imageDownloadObservers","engine","visor","Visor","mainLoop","FPSIndicator","msToBlob","blob","navigator","msSaveBlob","toBlob","link","download","href","URL","createObjectURL","click","requestAnimationFrame","main","controlId","callObservers","observers","observer","isInValuePickingMode","updateParametersVisibility","Controls","setVisibility","clearPreset","Select","setValue","Range","addObserver","Tabs","getValues","exitValuePickingMode","setValues","getValue","storeState","Checkbox","isChecked","Observers","canvasResize","callResetObservers","Button","clearStoredState","updateIndicatorsVisibility","setIndicatorsVisibility","FileControl","addUploadObserver","filesList","FileReader","Image","addEventListener","src","result","readAsDataURL","applyCurrentPreset","selectedPresetId","preset","Presets","aFeeding","aDiffuse","bKilling","bDiffuse","addDownloadObserver","mouseDrag","presets","COLORSCALE","defaultImageData","ImageData","createImageData","buildDefaultImageData","_width","_height","createTexture","rampImage","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","texImage2D","RGBA","UNSIGNED_BYTE","previousTexture","RenderToTexture","framebuffer","tmp","createFramebuffer","wantedWidth","wantedHeight","format","framebufferTexture2D","COLOR_ATTACHMENT0","EBarDirection","container","getCanvasContainer","horizontalLine","createBar","HORIZONTAL","appendChild","verticalLine","VERTICAL","currentPos","aimedFeedA","aimedKillB","isVisible","legendValue","textContent","canvasSize","getSize","hPixel","vPixel","left","legendContainer","getBoundingClientRect","top","display","mousePos","adjustedY","clamp","interpolate","adjustedX","direction","label","classList","add","labelElement","maxDigits","raw","dotIndex","indexOf","nbDigits","substring","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","call"],"mappings":"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","file":"main.min.js","sourcesContent":["import { EDisplayMode, EInitialState, EParametersMap, EShading } from \"./enums\";\r\nimport { gl } from \"./gl-utils/gl-canvas\";\r\nimport { Shader } from \"./gl-utils/shader\";\r\nimport * as ShaderManager from \"./gl-utils/shader-manager\";\r\nimport { VBO } from \"./gl-utils/vbo\";\r\nimport * as InputImage from \"./input-image\";\r\nimport * as Loader from \"./loader\";\r\nimport { Parameters } from \"./parameters\";\r\nimport { ImageTexture } from \"./texture/image-texture\";\r\nimport { RenderToTextureSwapable } from \"./texture/render-to-texture-swapable\";\r\n\r\n\r\nfunction isInRange(min: number, max: number, x: number): boolean {\r\n    return min <= x && x <= max;\r\n}\r\n\r\nclass Engine {\r\n    public static readonly A_FEEDING_MIN: number = 0.01;\r\n    public static readonly A_FEEDING_MAX: number = 0.1;\r\n    public static readonly B_KILLING_MIN: number = 0.045;\r\n    public static readonly B_KILLING_MAX: number = 0.07;\r\n\r\n    private displayMonochromeShader: Shader;\r\n    private displayTricolorShader: Shader;\r\n    private displayRampShader: Shader;\r\n\r\n    private updateUniformShader: Shader;\r\n    private updateMapShader: Shader;\r\n    private updateImageMapShader: Shader;\r\n\r\n    private resetShader: Shader;\r\n    private brushApplyShader: Shader;\r\n    private brushDisplayShader: Shader;\r\n\r\n    private readonly squareVBO: VBO;\r\n\r\n    private readonly greyscaleTexture: ImageTexture;\r\n    private readonly colorscaleTexture: ImageTexture;\r\n\r\n    // first one is used for monochrome or red\r\n    // second one is used for green\r\n    // thrid one is used for blue\r\n    private readonly internalTextures: [RenderToTextureSwapable, RenderToTextureSwapable, RenderToTextureSwapable]; // used for monochrome or red\r\n\r\n    private needToReset: boolean;\r\n\r\n    private lastUpdateTimestamp: number = 0;\r\n    private _iteration: number;\r\n    private lastIterationUpdate: number;\r\n\r\n    private targetWidth: number = 1;\r\n    private targetHeight: number = 1;\r\n\r\n    public constructor() {\r\n        this.squareVBO = VBO.createQuad(gl, -1, -1, +1, +1);\r\n\r\n        this.greyscaleTexture = new ImageTexture();\r\n        this.greyscaleTexture.loadFromUrl(\"./resources/greyscale.png\");\r\n\r\n        this.colorscaleTexture = new ImageTexture();\r\n        this.colorscaleTexture.loadFromUrl(\"./resources/colorscale.png\");\r\n\r\n        this.internalTextures = [\r\n            new RenderToTextureSwapable(),\r\n            new RenderToTextureSwapable(),\r\n            new RenderToTextureSwapable(),\r\n        ];\r\n\r\n        this.needToReset = true;\r\n        this.lastIterationUpdate = performance.now() - 5000;\r\n        this.iteration = 0;\r\n\r\n        this.asyncLoadShader(\"display-monochrome\", \"display/display.vert\", \"display/display-monochrome.frag\", (shader: Shader) => { this.displayMonochromeShader = shader; });\r\n        this.asyncLoadShader(\"display-tricolor\", \"display/display.vert\", \"display/display-tricolor.frag\", (shader: Shader) => { this.displayTricolorShader = shader; });\r\n        this.asyncLoadShader(\"display-ramp\", \"display/display.vert\", \"display/display-ramp.frag\", (shader: Shader) => { this.displayRampShader = shader; });\r\n\r\n        this.asyncLoadShader(\"update-uniform\", \"update/update.vert\", \"update/update-uniform.frag\", (shader: Shader) => { this.updateUniformShader = shader; });\r\n        this.asyncLoadShader(\"update-map\", \"update/update.vert\", \"update/update-map.frag\", (shader: Shader) => { this.updateMapShader = shader; },\r\n            {\r\n                A_FEEDING_MIN: Engine.A_FEEDING_MIN.toFixed(5),\r\n                A_FEEDING_MAX: Engine.A_FEEDING_MAX.toFixed(5),\r\n                B_KILLING_MIN: Engine.B_KILLING_MIN.toFixed(5),\r\n                B_KILLING_MAX: Engine.B_KILLING_MAX.toFixed(5),\r\n            });\r\n        this.asyncLoadShader(\"update-image\", \"update/update.vert\", \"update/update-map-image.frag\", (shader: Shader) => { this.updateImageMapShader = shader; });\r\n\r\n        this.asyncLoadShader(\"reset\", \"update/update.vert\", \"update/reset.frag\", (shader: Shader) => { this.resetShader = shader; });\r\n        this.asyncLoadShader(\"brush-apply\", \"update/brush.vert\", \"update/brush-apply.frag\", (shader: Shader) => { this.brushApplyShader = shader; });\r\n        this.asyncLoadShader(\"brush-display\", \"update/brush.vert\", \"update/brush-display.frag\", (shader: Shader) => { this.brushDisplayShader = shader; });\r\n    }\r\n\r\n    public resize(width: number, height: number): void {\r\n        this.targetWidth = width;\r\n        this.targetHeight = height;\r\n    }\r\n\r\n    public reset(): void {\r\n        this.needToReset = true;\r\n    }\r\n\r\n    public drawToCanvas(): void {\r\n        gl.viewport(0, 0, this.targetWidth, this.targetHeight);\r\n\r\n        let shader: Shader;\r\n\r\n        const displayMode = Parameters.displayMode;\r\n        if (displayMode === EDisplayMode.MONOCHROME) {\r\n            const shading = Parameters.shading;\r\n            if (shading === EShading.BINARY) {\r\n                if (this.displayMonochromeShader) {\r\n                    this.displayMonochromeShader.u[\"uTexture\"].value = this.internalTextures[0].current;\r\n                    shader = this.displayMonochromeShader;\r\n                }\r\n            } else {\r\n                if (this.displayRampShader) {\r\n                    this.displayRampShader.u[\"uTexture\"].value = this.internalTextures[0].current;\r\n\r\n                    if (shading === EShading.GREYSCALE) {\r\n                        this.displayRampShader.u[\"uRamp\"].value = this.greyscaleTexture.id;\r\n                    } else {\r\n                        this.displayRampShader.u[\"uRamp\"].value = this.colorscaleTexture.id;\r\n                    }\r\n                    shader = this.displayRampShader;\r\n                }\r\n            }\r\n        } else if (displayMode === EDisplayMode.TRICOLOR) {\r\n            if (this.displayTricolorShader) {\r\n                this.displayTricolorShader.u[\"uTextureRed\"].value = this.internalTextures[0].current;\r\n                this.displayTricolorShader.u[\"uTextureGreen\"].value = this.internalTextures[1].current;\r\n                this.displayTricolorShader.u[\"uTextureBlue\"].value = this.internalTextures[2].current;\r\n                shader = this.displayTricolorShader;\r\n            }\r\n        }\r\n\r\n        if (shader) {\r\n            const map = Parameters.parametersMap;\r\n            if (map === EParametersMap.IMAGE) {\r\n                const canvasAspectRatio = this.targetWidth / this.targetHeight;\r\n                const internalTextureAspectRatio = this.internalTextures[0].width / this.internalTextures[0].height;\r\n\r\n                if (canvasAspectRatio > internalTextureAspectRatio) {\r\n                    shader.u[\"uScaling\"].value = [internalTextureAspectRatio / canvasAspectRatio, 1];\r\n                } else {\r\n                    shader.u[\"uScaling\"].value = [1, canvasAspectRatio / internalTextureAspectRatio];\r\n                }\r\n            } else {\r\n                shader.u[\"uScaling\"].value = [1, 1];\r\n            }\r\n            shader.u[\"uZoom\"].value = Parameters.zoom;\r\n\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            shader.use();\r\n            shader.bindUniformsAndAttributes();\r\n            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n        }\r\n    }\r\n\r\n    public update(): void {\r\n        if (this.adjustInternalTextureSize()) {\r\n            this.needToReset = true; // need to reset because internal textures were resized\r\n        }\r\n        gl.viewport(0, 0, this.internalTextures[0].width, this.internalTextures[0].height);\r\n\r\n        if (this.needToReset) {\r\n            this.iteration = 0;\r\n\r\n            if (!this.clearInternalTextures()) {\r\n                return;\r\n            }\r\n            this.needToReset = false;\r\n        }\r\n\r\n        this.handleBrush();\r\n\r\n        const nbIterations = this.computeNbIterationsForThisFrame();\r\n        if (nbIterations <= 0) {\r\n            return;\r\n        }\r\n\r\n        const map = Parameters.parametersMap;\r\n\r\n        if (map === EParametersMap.IMAGE) {\r\n            if (this.updateImageMapShader) {\r\n                const inputImageTexture = InputImage.getTexture();\r\n                this.updateImageMapShader.u[\"uImageMapTexture\"].value = inputImageTexture.id;\r\n                this.updateImageMapShader.u[\"uDiffuseScaling\"].value = Parameters.patternsScale;\r\n                this.updateImageMapShader.u[\"uTexelSize\"].value = [1 / this.internalTextures[0].width, 1 / this.internalTextures[0].height];\r\n\r\n                this.updateImageMapShader.use();\r\n                this.updateImageMapShader.bindAttributes();\r\n\r\n                if (Parameters.displayMode === EDisplayMode.MONOCHROME) {\r\n                    this.updateImageMapShader.u[\"uSampledChannel\"].value = [0, 0, 0, 1];\r\n                    this.updateInternal(this.updateImageMapShader, nbIterations, this.internalTextures[0]);\r\n                } else {\r\n                    const splitNbIterations = Math.ceil(nbIterations / 3);\r\n                    this.updateImageMapShader.u[\"uSampledChannel\"].value = [1, 0, 0, 0];\r\n                    this.updateInternal(this.updateImageMapShader, splitNbIterations, this.internalTextures[0]);\r\n\r\n                    this.updateImageMapShader.u[\"uSampledChannel\"].value = [0, 1, 0, 0];\r\n                    this.updateInternal(this.updateImageMapShader, splitNbIterations, this.internalTextures[1]);\r\n\r\n                    this.updateImageMapShader.u[\"uSampledChannel\"].value = [0, 0, 1, 0];\r\n                    this.updateInternal(this.updateImageMapShader, splitNbIterations, this.internalTextures[2]);\r\n                }\r\n            }\r\n        } else {\r\n            let updateShader: Shader;\r\n\r\n            if (map === EParametersMap.UNIFORM) {\r\n                if (this.updateUniformShader) {\r\n                    this.updateUniformShader.u[\"uRates\"].value = [\r\n                        Parameters.AFeedingRate,\r\n                        Parameters.BKillingRate,\r\n                        Parameters.ADiffusionRate,\r\n                        Parameters.BDIffusionRate,\r\n                    ];\r\n                    updateShader = this.updateUniformShader;\r\n                }\r\n            } else if (map === EParametersMap.VALUE_PICKING) {\r\n                if (this.updateMapShader) {\r\n                    this.updateMapShader.u[\"uRates\"].value = [\r\n                        Parameters.ADiffusionRate,\r\n                        Parameters.BDIffusionRate,\r\n                    ];\r\n                    updateShader = this.updateMapShader;\r\n                }\r\n            }\r\n\r\n            if (updateShader) {\r\n                updateShader.use();\r\n                updateShader.bindAttributes();\r\n                updateShader.u[\"uTexelSize\"].value = [1 / this.internalTextures[0].width, 1 / this.internalTextures[0].height];\r\n                this.updateInternal(updateShader, nbIterations, this.internalTextures[0]);\r\n            }\r\n        }\r\n    }\r\n\r\n    private updateInternal(shader: Shader, nbIterations: number, texture: RenderToTextureSwapable): void {\r\n        for (let i = nbIterations; i > 0; i--) {\r\n            texture.swap();\r\n\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, texture.currentFramebuffer);\r\n            shader.u[\"uPreviousIteration\"].value = texture.previous;\r\n            shader.bindUniforms();\r\n            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n        }\r\n        this.iteration = this._iteration + nbIterations;\r\n    }\r\n\r\n    public displayBrush(): void {\r\n        if (Parameters.parametersMap !== EParametersMap.VALUE_PICKING && this.brushDisplayShader) {\r\n            const size = Parameters.brushSize;\r\n            const mousePosition = Page.Canvas.getMousePosition();\r\n\r\n            this.brushDisplayShader.u[\"uPosition\"].value = [2 * (mousePosition[0] - 0.5), -2 * (mousePosition[1] - 0.5)];\r\n            this.brushDisplayShader.u[\"uSize\"].value = [size / this.targetWidth, size / this.targetHeight];\r\n\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            this.brushDisplayShader.use();\r\n            this.brushDisplayShader.bindUniformsAndAttributes();\r\n            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n        }\r\n    }\r\n\r\n    private handleBrush(): void {\r\n        const map = Parameters.parametersMap;\r\n        if (map !== EParametersMap.VALUE_PICKING && this.brushApplyShader && Page.Canvas.isMouseDown()) {\r\n            const mousePosition = Page.Canvas.getMousePosition();\r\n            if (isInRange(0, 1, mousePosition[0]) && isInRange(0, 1, mousePosition[1])) {\r\n                const size = Parameters.brushSize;\r\n                const zoom = Parameters.zoom;\r\n                const position = [2 * (mousePosition[0] - 0.5) / zoom, -2 * (mousePosition[1] - 0.5) / zoom];\r\n\r\n                if (map === EParametersMap.IMAGE) {\r\n                    const canvasAspectRatio = this.targetWidth / this.targetHeight;\r\n                    const internalTextureAspectRatio = this.internalTextures[0].width / this.internalTextures[0].height;\r\n\r\n                    if (canvasAspectRatio > internalTextureAspectRatio) {\r\n                        position[0] *= canvasAspectRatio / internalTextureAspectRatio;\r\n                    } else if (canvasAspectRatio < internalTextureAspectRatio) {\r\n                        position[1] *= internalTextureAspectRatio / canvasAspectRatio;\r\n                    }\r\n                }\r\n\r\n                this.brushApplyShader.u[\"uPosition\"].value = position;\r\n                this.brushApplyShader.u[\"uSize\"].value = [size / this.internalTextures[0].width / zoom, size / this.internalTextures[0].height / zoom];\r\n\r\n                this.brushApplyShader.use();\r\n                this.brushApplyShader.bindUniformsAndAttributes();\r\n\r\n                for (const texture of this.internalTextures) {\r\n                    gl.bindFramebuffer(gl.FRAMEBUFFER, texture.currentFramebuffer);\r\n                    gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    public clearInternalTextures(): boolean {\r\n        if (this.resetShader) {\r\n            const pattern = Parameters.initialState;\r\n            this.resetShader.u[\"uPattern\"].value = [pattern === EInitialState.BLANK, pattern === EInitialState.DISC, pattern === EInitialState.CIRCLE, 0];\r\n\r\n            this.resetShader.use();\r\n            this.resetShader.bindUniformsAndAttributes();\r\n\r\n            for (const texture of this.internalTextures) {\r\n                gl.bindFramebuffer(gl.FRAMEBUFFER, texture.currentFramebuffer);\r\n                gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    private adjustInternalTextureSize(): boolean {\r\n        let neededWidth = this.targetWidth;\r\n        let neededHeight = this.targetHeight;\r\n\r\n        if (Parameters.parametersMap === EParametersMap.IMAGE) {\r\n            const canvasAspectRatio = this.targetWidth / this.targetHeight;\r\n            const imageAspectRatio = InputImage.getTexture().width / InputImage.getTexture().height;\r\n\r\n            if (canvasAspectRatio > imageAspectRatio) {\r\n                neededWidth = Math.ceil(imageAspectRatio / canvasAspectRatio * this.targetWidth);\r\n            } else if (canvasAspectRatio < imageAspectRatio) {\r\n                neededHeight = Math.ceil(canvasAspectRatio / imageAspectRatio * this.targetHeight);\r\n            }\r\n        }\r\n\r\n        if (this.internalTextures[0].width !== neededWidth || this.internalTextures[0].height !== neededHeight) {\r\n            for (const texture of this.internalTextures) {\r\n                texture.reserveSpace(neededWidth, neededHeight);\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    private set iteration(i: number) {\r\n        this._iteration = i;\r\n\r\n        const now = performance.now();\r\n        if (now - this.lastIterationUpdate > 200) {\r\n            Page.Canvas.setIndicatorText(\"iteration-indicator\", this._iteration.toString());\r\n            this.lastIterationUpdate = now;\r\n        }\r\n    }\r\n\r\n    private computeNbIterationsForThisFrame(): number {\r\n        // Limit update speed to have same speed at 144fps than at 60fps\r\n        const nbIterationsPerFrameAt60FPS = Parameters.speed;\r\n        const MAX_FPS = 60;\r\n        const MIN_FPS = 10;\r\n\r\n        const now = performance.now();\r\n        const instantFPS = 1000 / (0.1 + now - this.lastUpdateTimestamp);\r\n        this.lastUpdateTimestamp = now;\r\n\r\n        if (instantFPS > MAX_FPS) { // runs very fast, limit update speed to run with expected speed\r\n            return Math.ceil(MAX_FPS / instantFPS * nbIterationsPerFrameAt60FPS);\r\n        } else if (instantFPS < MIN_FPS) { // runs very slow, try to reduce the workload to avoid huge freezes\r\n            return Math.ceil(instantFPS / MIN_FPS * nbIterationsPerFrameAt60FPS);\r\n        }\r\n\r\n        return nbIterationsPerFrameAt60FPS;\r\n    }\r\n\r\n    private asyncLoadShader(name: string, vertexFilename: string, fragmentFilename: string, callback: (shader: Shader) => unknown, injected: any = {}): void {\r\n        const id = `shader-${name}`;\r\n        Loader.registerLoadingObject(id);\r\n\r\n        ShaderManager.buildShader({\r\n            fragmentFilename,\r\n            vertexFilename,\r\n            injected,\r\n        }, (builtShader: Shader | null) => {\r\n            Loader.registerLoadedObject(id);\r\n\r\n            if (builtShader !== null) {\r\n                builtShader.a[\"aCorner\"].VBO = this.squareVBO;\r\n                callback(builtShader);\r\n            } else {\r\n                Page.Demopage.setErrorMessage(`${name}-shader-error`, `Failed to build '${name}' shader.`);\r\n            }\r\n        });\r\n    }\r\n\r\n}\r\n\r\nexport {\r\n    Engine,\r\n};\r\n","enum EParametersMap {\r\n    UNIFORM = \"uniform\",\r\n    VALUE_PICKING = \"value_picking\", // technical, not defined in the control\r\n    IMAGE = \"image\",\r\n}\r\n\r\nenum EInitialState {\r\n    BLANK = \"blank\",\r\n    DISC = \"disc\",\r\n    CIRCLE = \"circle\",\r\n}\r\n\r\nenum EDisplayMode {\r\n    MONOCHROME = \"monochrome\",\r\n    TRICOLOR = \"tricolor\",\r\n}\r\n\r\nenum EShading {\r\n    BINARY = \"binary\",\r\n    GREYSCALE = \"greyscale\",\r\n    COLORSCALE = \"colorscale\",\r\n}\r\n\r\nexport {\r\n    EDisplayMode,\r\n    EInitialState,\r\n    EShading,\r\n    EParametersMap,\r\n};\r\n","import \"./page-interface-generated\";\r\n\r\n\r\nlet framesSinceLastFPSUpdate = 0;\r\nlet timeOfLastFPSUpdate = performance.now();\r\n\r\nsetInterval(() => {\r\n    const now = performance.now();\r\n    const fps = 1000 * framesSinceLastFPSUpdate / (now - timeOfLastFPSUpdate);\r\n    timeOfLastFPSUpdate = now;\r\n    framesSinceLastFPSUpdate = 0;\r\n\r\n    Page.Canvas.setIndicatorText(\"fps-indicator\", Math.round(fps).toString());\r\n}, 500);\r\n\r\nfunction registerFrame(): void {\r\n    framesSinceLastFPSUpdate++;\r\n}\r\n\r\nexport { registerFrame };\r\n","import \"../page-interface-generated\";\r\n\r\nlet gl: WebGLRenderingContext = null;\r\n\r\n/** Initializes a WebGL context */\r\nfunction initGL(flags?: object): boolean {\r\n    function setError(message: string): void {\r\n        Page.Demopage.setErrorMessage(\"webgl-support\", message);\r\n    }\r\n\r\n    const canvas = Page.Canvas.getCanvas();\r\n\r\n    gl = canvas.getContext(\"webgl\", flags) as WebGLRenderingContext;\r\n    if (gl == null) {\r\n        gl = canvas.getContext(\"experimental-webgl\", flags) as WebGLRenderingContext;\r\n        if (gl == null) {\r\n            setError(\"Your browser or device does not seem to support WebGL.\");\r\n            return false;\r\n        }\r\n\r\n        setError(`Your browser or device only supports experimental WebGL.\r\nThe simulation may not run as expected.`);\r\n    }\r\n\r\n    gl.disable(gl.CULL_FACE);\r\n    gl.disable(gl.DEPTH_TEST);\r\n    gl.disable(gl.BLEND);\r\n    gl.clearColor(0, 0, 0, 1);\r\n\r\n    return true;\r\n}\r\n\r\n/* Adjusts the GL canvas size to the actual canvas element size on the page */\r\nfunction adjustSize(hidpi: boolean = false): void {\r\n    const cssPixel: number = (hidpi) ? window.devicePixelRatio : 1;\r\n\r\n    const canvas = gl.canvas as HTMLCanvasElement;\r\n\r\n    const width: number = Math.floor(canvas.clientWidth * cssPixel);\r\n    const height: number = Math.floor(canvas.clientHeight * cssPixel);\r\n    if (canvas.width !== width || canvas.height !== height) {\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n    }\r\n}\r\n\r\nexport {\r\n    adjustSize,\r\n    initGL,\r\n    gl,\r\n};\r\n","abstract class GLResource {\r\n    private _gl: WebGLRenderingContext;\r\n\r\n    constructor(gl: WebGLRenderingContext) {\r\n        this._gl = gl;\r\n    }\r\n\r\n    public gl(): WebGLRenderingContext {\r\n        return this._gl;\r\n    }\r\n\r\n    public abstract freeGLResources(): void;\r\n}\r\n\r\nexport { GLResource };\r\n","import { gl } from \"./gl-canvas\";\r\nimport { Shader } from \"./shader\";\r\nimport * as ShaderSources from \"./shader-sources\";\r\n\r\ntype RegisterCallback = (success: boolean, shader: Shader | null) => void;\r\n\r\ninterface IShaderInfos {\r\n    fragmentFilename: string;\r\n    vertexFilename: string;\r\n    injected: { [id: string]: string };\r\n}\r\n\r\ninterface ICachedShader {\r\n    shader: Shader | null;\r\n    infos: IShaderInfos;\r\n    pending: boolean;\r\n    failed: boolean;\r\n    callbacks: RegisterCallback[];\r\n}\r\n\r\nconst cachedShaders: { [id: string]: ICachedShader } = {};\r\n\r\nfunction getShader(name: string): Shader | null {\r\n    return cachedShaders[name].shader;\r\n}\r\n\r\ntype BuildCallback = (builtShader: Shader | null) => void;\r\n\r\nfunction buildShader(infos: IShaderInfos, callback: BuildCallback): void {\r\n    let sourcesPending = 2;\r\n    let sourcesFailed = 0;\r\n\r\n    function loadedSource(success: boolean): void {\r\n        function processSource(source: string): string {\r\n            return source.replace(/#INJECT\\(([^)]*)\\)/mg, (match: string, name: string) => {\r\n                if (infos.injected[name]) {\r\n                    return infos.injected[name];\r\n                }\r\n                return match;\r\n            });\r\n        }\r\n\r\n        sourcesPending--;\r\n        if (!success) {\r\n            sourcesFailed++;\r\n        }\r\n\r\n        if (sourcesPending === 0) {\r\n            let shader = null;\r\n\r\n            if (sourcesFailed === 0) {\r\n                const vert = ShaderSources.getSource(infos.vertexFilename);\r\n                const frag = ShaderSources.getSource(infos.fragmentFilename);\r\n\r\n                const processedVert = processSource(vert);\r\n                const processedFrag = processSource(frag);\r\n                shader = new Shader(gl, processedVert, processedFrag);\r\n            }\r\n\r\n            callback(shader);\r\n        }\r\n    }\r\n\r\n    ShaderSources.loadSource(infos.vertexFilename, loadedSource);\r\n    ShaderSources.loadSource(infos.fragmentFilename, loadedSource);\r\n}\r\n\r\nfunction registerShader(name: string, infos: IShaderInfos, callback: RegisterCallback): void {\r\n    function callAndClearCallbacks(cached: ICachedShader): void {\r\n        for (const cachedCallback of cached.callbacks) {\r\n            cachedCallback(!cached.failed, cached.shader);\r\n        }\r\n\r\n        cached.callbacks = [];\r\n    }\r\n\r\n    if (typeof cachedShaders[name] === \"undefined\") {\r\n        cachedShaders[name] = {\r\n            callbacks: [callback],\r\n            failed: false,\r\n            infos,\r\n            pending: true,\r\n            shader: null,\r\n        };\r\n        const cached = cachedShaders[name];\r\n\r\n        buildShader(infos, (builtShader: Shader | null) => {\r\n            cached.pending = false;\r\n            cached.failed = builtShader === null;\r\n            cached.shader = builtShader;\r\n\r\n            callAndClearCallbacks(cached);\r\n        });\r\n    } else {\r\n        const cached = cachedShaders[name];\r\n\r\n        if (cached.pending === true) {\r\n            cached.callbacks.push(callback);\r\n        } else {\r\n            callAndClearCallbacks(cached);\r\n        }\r\n    }\r\n}\r\n\r\nfunction deleteShader(name: string): void {\r\n    if (typeof cachedShaders[name] !== \"undefined\") {\r\n        if (cachedShaders[name].shader !== null) {\r\n            cachedShaders[name].shader.freeGLResources();\r\n        }\r\n        delete cachedShaders[name];\r\n    }\r\n}\r\n\r\nexport {\r\n    buildShader,\r\n    getShader,\r\n    IShaderInfos,\r\n    registerShader,\r\n    deleteShader,\r\n};\r\n","type LoadCallback = (success: boolean) => void;\r\n\r\ninterface ICachedSource {\r\n    text: string;\r\n    pending: boolean;\r\n    failed: boolean;\r\n    callbacks: LoadCallback[];\r\n}\r\n\r\nconst cachedSources: { [id: string]: ICachedSource } = {};\r\n\r\n/* Fetches asynchronously the shader source from server and stores it in cache. */\r\nfunction loadSource(filename: string, callback: LoadCallback): void {\r\n    function callAndClearCallbacks(cached: ICachedSource): void {\r\n        for (const cachedCallback of cached.callbacks) {\r\n            cachedCallback(!cached.failed);\r\n        }\r\n\r\n        cached.callbacks = [];\r\n    }\r\n\r\n    if (typeof cachedSources[filename] === \"undefined\") {\r\n        cachedSources[filename] = {\r\n            callbacks: [callback],\r\n            failed: false,\r\n            pending: true,\r\n            text: null,\r\n        };\r\n        const cached = cachedSources[filename];\r\n\r\n        let url = \"./shaders/\" + filename;\r\n        if (typeof Page.version !== \"undefined\") {\r\n            url += `?v=${Page.version}`;\r\n        }\r\n        const xhr = new XMLHttpRequest();\r\n        xhr.open(\"GET\", url, true);\r\n        xhr.onload = () => {\r\n            if (xhr.readyState === 4) {\r\n                cached.pending = false;\r\n\r\n                if (xhr.status === 200) {\r\n                    cached.text = xhr.responseText;\r\n                    cached.failed = false;\r\n                } else {\r\n                    console.error(`Cannot load '${filename}' shader source: ${xhr.statusText}`);\r\n                    cached.failed = true;\r\n                }\r\n\r\n                callAndClearCallbacks(cached);\r\n            }\r\n        };\r\n        xhr.onerror = () => {\r\n            console.error(`Cannot load '${filename}' shader source: ${xhr.statusText}`);\r\n            cached.pending = false;\r\n            cached.failed = true;\r\n            callAndClearCallbacks(cached);\r\n        };\r\n\r\n        xhr.send(null);\r\n    } else {\r\n        const cached = cachedSources[filename];\r\n\r\n        if (cached.pending === true) {\r\n            cached.callbacks.push(callback);\r\n        } else {\r\n            cached.callbacks = [callback];\r\n            callAndClearCallbacks(cached);\r\n        }\r\n    }\r\n}\r\n\r\nfunction getSource(filename: string): string {\r\n    return cachedSources[filename].text;\r\n}\r\n\r\nexport {\r\n    getSource,\r\n    loadSource,\r\n};\r\n","import { GLResource } from \"./gl-resource\";\r\nimport { VBO } from \"./vbo\";\r\n\r\nfunction notImplemented(): void {\r\n    alert(\"NOT IMPLEMENTED YET\");\r\n}\r\n\r\nfunction bindUniformFloat(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number | number[]): void;\r\nfunction bindUniformFloat(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    if (Array.isArray(value)) {\r\n        gl.uniform1fv(location, value);\r\n    } else {\r\n        gl.uniform1f(location, value);\r\n    }\r\n}\r\n\r\nfunction bindUniformFloat2v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform2fv(location, value);\r\n}\r\n\r\nfunction bindUniformFloat3v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform3fv(location, value);\r\n}\r\n\r\nfunction bindUniformFloat4v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform4fv(location, value);\r\n}\r\n\r\nfunction bindUniformInt(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number | number[]): void;\r\nfunction bindUniformInt(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    if (Array.isArray(value)) {\r\n        gl.uniform1iv(location, value);\r\n    } else {\r\n        gl.uniform1iv(location, value);\r\n    }\r\n}\r\n\r\nfunction bindUniformInt2v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform2iv(location, value);\r\n}\r\n\r\nfunction bindUniformInt3v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform3iv(location, value);\r\n}\r\n\r\nfunction bindUniformInt4v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniform4iv(location, value);\r\n}\r\n\r\nfunction bindUniformBool(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: boolean | number): void {\r\n    gl.uniform1i(location, +value);\r\n}\r\n\r\nfunction bindUniformBool2v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    gl.uniform2iv(location, value);\r\n}\r\n\r\nfunction bindUniformBool3v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    gl.uniform3iv(location, value);\r\n}\r\n\r\nfunction bindUniformBool4v(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: any): void {\r\n    gl.uniform4iv(location, value);\r\n}\r\n\r\nfunction bindUniformFloatMat2(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniformMatrix2fv(location, false, value);\r\n}\r\n\r\nfunction bindUniformFloatMat3(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniformMatrix3fv(location, false, value);\r\n}\r\n\r\nfunction bindUniformFloatMat4(gl: WebGLRenderingContext, location: WebGLUniformLocation, value: number[]): void {\r\n    gl.uniformMatrix4fv(location, false, value);\r\n}\r\n\r\nfunction bindSampler2D(gl: WebGLRenderingContext, location: WebGLUniformLocation, unitNb: number,\r\n    value: WebGLTexture): void {\r\n    gl.uniform1i(location, unitNb);\r\n    gl.activeTexture((gl as any)[\"TEXTURE\" + unitNb] as number);\r\n    gl.bindTexture(gl.TEXTURE_2D, value);\r\n}\r\n\r\nfunction bindSamplerCube(gl: WebGLRenderingContext, location: WebGLUniformLocation, unitNb: number,\r\n    value: WebGLTexture): void {\r\n    gl.uniform1i(location, unitNb);\r\n    gl.activeTexture((gl as any)[\"TEXTURE\" + unitNb] as number);\r\n    gl.bindTexture(gl.TEXTURE_CUBE_MAP, value);\r\n}\r\n\r\n/* From WebGL spec:\r\n* http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.14 */\r\ninterface IBindingType {\r\n    str: string;\r\n    binder: (...args: any[]) => unknown;\r\n}\r\nconst types: { [index: string]: IBindingType } = {\r\n    0x8B50: { str: \"FLOAT_VEC2\", binder: bindUniformFloat2v },\r\n    0x8B51: { str: \"FLOAT_VEC3\", binder: bindUniformFloat3v },\r\n    0x8B52: { str: \"FLOAT_VEC4\", binder: bindUniformFloat4v },\r\n    0x8B53: { str: \"INT_VEC2\", binder: bindUniformInt2v },\r\n    0x8B54: { str: \"INT_VEC3\", binder: bindUniformInt3v },\r\n    0x8B55: { str: \"INT_VEC4\", binder: bindUniformInt4v },\r\n    0x8B56: { str: \"BOOL\", binder: bindUniformBool },\r\n    0x8B57: { str: \"BOOL_VEC2\", binder: bindUniformBool2v },\r\n    0x8B58: { str: \"BOOL_VEC3\", binder: bindUniformBool3v },\r\n    0x8B59: { str: \"BOOL_VEC4\", binder: bindUniformBool4v },\r\n    0x8B5A: { str: \"FLOAT_MAT2\", binder: bindUniformFloatMat2 },\r\n    0x8B5B: { str: \"FLOAT_MAT3\", binder: bindUniformFloatMat3 },\r\n    0x8B5C: { str: \"FLOAT_MAT4\", binder: bindUniformFloatMat4 },\r\n    0x8B5E: { str: \"SAMPLER_2D\", binder: bindSampler2D },\r\n    0x8B60: { str: \"SAMPLER_CUBE\", binder: bindSamplerCube },\r\n    0x1400: { str: \"BYTE\", binder: notImplemented },\r\n    0x1401: { str: \"UNSIGNED_BYTE\", binder: notImplemented },\r\n    0x1402: { str: \"SHORT\", binder: notImplemented },\r\n    0x1403: { str: \"UNSIGNED_SHORT\", binder: notImplemented },\r\n    0x1404: { str: \"INT\", binder: bindUniformInt },\r\n    0x1405: { str: \"UNSIGNED_INT\", binder: notImplemented },\r\n    0x1406: { str: \"FLOAT\", binder: bindUniformFloat },\r\n};\r\n\r\ninterface IShaderUniform {\r\n    value: boolean | boolean[] | number | number[] | WebGLTexture | WebGLTexture[];\r\n    loc: WebGLUniformLocation;\r\n    size: number;\r\n    type: number;\r\n}\r\n\r\ninterface IShaderAttribute {\r\n    VBO: VBO;\r\n    loc: GLint;\r\n    size: number;\r\n    type: number;\r\n}\r\n\r\nclass ShaderProgram extends GLResource {\r\n    public u: { [name: string]: IShaderUniform };\r\n    public a: { [name: string]: IShaderAttribute };\r\n\r\n    private id: WebGLProgram;\r\n    private uCount: number;\r\n    private aCount: number;\r\n\r\n    constructor(gl: WebGLRenderingContext, vertexSource: string, fragmentSource: string) {\r\n        function createShader(type: GLenum, source: string): WebGLShader {\r\n            const shader = gl.createShader(type);\r\n            gl.shaderSource(shader, source);\r\n            gl.compileShader(shader);\r\n\r\n            const compileSuccess = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\r\n            if (!compileSuccess) {\r\n                console.error(gl.getShaderInfoLog(shader));\r\n                console.log(source);\r\n                gl.deleteShader(shader);\r\n                return null;\r\n            }\r\n\r\n            return shader;\r\n        }\r\n\r\n        super(gl);\r\n\r\n        this.id = null;\r\n        this.uCount = 0;\r\n        this.aCount = 0;\r\n\r\n        const vertexShader = createShader(gl.VERTEX_SHADER, vertexSource);\r\n        const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragmentSource);\r\n\r\n        const id = gl.createProgram();\r\n        gl.attachShader(id, vertexShader);\r\n        gl.attachShader(id, fragmentShader);\r\n        gl.linkProgram(id);\r\n\r\n        const linkSuccess = gl.getProgramParameter(id, gl.LINK_STATUS);\r\n        if (!linkSuccess) {\r\n            console.error(gl.getProgramInfoLog(id));\r\n            gl.deleteProgram(id);\r\n        } else {\r\n            this.id = id;\r\n\r\n            this.introspection();\r\n        }\r\n    }\r\n\r\n    public freeGLResources(): void {\r\n        super.gl().deleteProgram(this.id);\r\n        this.id = null;\r\n    }\r\n\r\n    public use(): void {\r\n        super.gl().useProgram(this.id);\r\n    }\r\n\r\n    public bindUniforms(): void {\r\n        const gl: WebGLRenderingContext = super.gl();\r\n        let currTextureUnitNb: number = 0;\r\n\r\n        Object.keys(this.u).forEach((uName: string) => {\r\n            const uniform = this.u[uName];\r\n            if (uniform.value !== null) {\r\n                if (uniform.type === 0x8B5E || uniform.type === 0x8B60) {\r\n                    const unitNb: number = currTextureUnitNb;\r\n                    types[uniform.type].binder(gl, uniform.loc, unitNb, uniform.value);\r\n                    currTextureUnitNb++;\r\n                } else {\r\n                    types[uniform.type].binder(gl, uniform.loc, uniform.value);\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    public bindAttributes(): void {\r\n        Object.keys(this.a).forEach((aName: string) => {\r\n            const attribute = this.a[aName];\r\n            if (attribute.VBO !== null) {\r\n                attribute.VBO.bind(attribute.loc);\r\n            }\r\n        });\r\n    }\r\n\r\n    public bindUniformsAndAttributes(): void {\r\n        this.bindUniforms();\r\n        this.bindAttributes();\r\n    }\r\n\r\n    private introspection(): void {\r\n        const gl = super.gl();\r\n\r\n        this.uCount = gl.getProgramParameter(this.id, gl.ACTIVE_UNIFORMS);\r\n        this.u = {};\r\n        for (let i = 0; i < this.uCount; i++) {\r\n            const uniform = gl.getActiveUniform(this.id, i);\r\n            const name = uniform.name;\r\n\r\n            this.u[name] = {\r\n                loc: gl.getUniformLocation(this.id, name),\r\n                size: uniform.size,\r\n                type: uniform.type,\r\n                value: null,\r\n            };\r\n        }\r\n\r\n        this.aCount = gl.getProgramParameter(this.id, gl.ACTIVE_ATTRIBUTES);\r\n        this.a = {};\r\n        for (let i = 0; i < this.aCount; i++) {\r\n            const attribute = gl.getActiveAttrib(this.id, i);\r\n            const name = attribute.name;\r\n\r\n            this.a[name] = {\r\n                VBO: null,\r\n                loc: gl.getAttribLocation(this.id, name),\r\n                size: attribute.size,\r\n                type: attribute.type,\r\n            };\r\n        }\r\n    }\r\n}\r\n\r\nexport { ShaderProgram as Shader };\r\n","import { GLResource } from \"./gl-resource\";\r\n\r\nenum Usage {\r\n    DYNAMIC,\r\n    STATIC,\r\n}\r\n\r\nclass VBO extends GLResource {\r\n    public static createQuad(gl: WebGLRenderingContext, minX: number, minY: number, maxX: number, maxY: number): VBO {\r\n        const vert = [\r\n            minX, minY,\r\n            maxX, minY,\r\n            minX, maxY,\r\n            maxX, maxY,\r\n        ];\r\n\r\n        return new VBO(gl, new Float32Array(vert), 2, gl.FLOAT, true);\r\n    }\r\n\r\n    private id: WebGLBuffer;\r\n    private size: number;\r\n    private type: GLenum;\r\n    private normalize: GLboolean;\r\n    private stride: GLsizei;\r\n    private offset: GLintptr;\r\n    private usage: Usage;\r\n\r\n    constructor(gl: WebGLRenderingContext, array: any, size: number, type: GLenum, staticUsage: boolean = true) {\r\n        super(gl);\r\n\r\n        this.id = gl.createBuffer();\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, this.id);\r\n        if (staticUsage) {\r\n            gl.bufferData(gl.ARRAY_BUFFER, array, gl.STATIC_DRAW);\r\n        } else {\r\n            gl.bufferData(gl.ARRAY_BUFFER, array, gl.DYNAMIC_DRAW);\r\n        }\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n\r\n        this.size = size;\r\n        this.type = type;\r\n        this.normalize = false;\r\n        this.stride = 0;\r\n        this.offset = 0;\r\n        this.usage = (staticUsage) ? Usage.STATIC : Usage.DYNAMIC;\r\n    }\r\n\r\n    public freeGLResources(): void {\r\n        this.gl().deleteBuffer(this.id);\r\n        this.id = null;\r\n    }\r\n\r\n    public bind(location: GLuint): void {\r\n        const gl = super.gl();\r\n        gl.enableVertexAttribArray(location);\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, this.id);\r\n        gl.vertexAttribPointer(location, this.size, this.type, this.normalize, this.stride, this.offset);\r\n    }\r\n\r\n    public setData(array: any): void {\r\n        const gl = super.gl();\r\n\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, this.id);\r\n        if (this.usage === Usage.STATIC) {\r\n            gl.bufferData(gl.ARRAY_BUFFER, array, gl.STATIC_DRAW);\r\n        } else {\r\n            gl.bufferData(gl.ARRAY_BUFFER, array, gl.DYNAMIC_DRAW);\r\n        }\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n    }\r\n}\r\n\r\nexport { VBO };\r\n","import { Parameters } from \"./parameters\";\r\nimport { ImageTexture } from \"./texture/image-texture\";\r\n\r\n\r\nconst maxResolution = 512;\r\nconst hiddenCanvas = document.createElement(\"canvas\");\r\nconst hiddenCanvasContext = hiddenCanvas.getContext(\"2d\");\r\n\r\nlet currentImageData: ImageData;\r\nlet currentTexture: ImageTexture = null;\r\n\r\nfunction computeBrightness(r: number, g: number, b: number): number {\r\n    return (0.21 * r) + (0.72 * g) + (0.07 * b);\r\n}\r\n\r\nfunction downsizeImageIfNeeded(image: HTMLImageElement): ImageData {\r\n    const scalingFactor = Math.min(1, maxResolution / Math.max(image.width, image.height));\r\n    const finalWidth = Math.ceil(scalingFactor * image.width);\r\n    const finalHeight = Math.ceil(scalingFactor * image.height);\r\n\r\n    hiddenCanvas.width = finalWidth;\r\n    hiddenCanvas.height = finalHeight;\r\n    hiddenCanvasContext.drawImage(image, 0, 0, finalWidth, finalHeight);\r\n\r\n    const imageData = hiddenCanvasContext.getImageData(0, 0, hiddenCanvas.width, hiddenCanvas.height);\r\n    const rawDataCopy = new Uint8ClampedArray(imageData.data);\r\n\r\n    // revert vertically, and store brightness in alpha channel\r\n    let i = 0;\r\n    for (let iY = imageData.height - 1; iY >= 0; iY--) {\r\n        for (let iX = 0; iX < imageData.width; iX++) {\r\n            const r = rawDataCopy[4 * (iX + iY * imageData.width)];\r\n            const g = rawDataCopy[4 * (iX + iY * imageData.width) + 1];\r\n            const b = rawDataCopy[4 * (iX + iY * imageData.width) + 2];\r\n            const brightness = computeBrightness(r, g, b);\r\n            imageData.data[i++] = r;\r\n            imageData.data[i++] = g;\r\n            imageData.data[i++] = b;\r\n            imageData.data[i++] = brightness;\r\n        }\r\n    }\r\n    return imageData;\r\n}\r\n\r\nParameters.imageUploadObservers.push((image: HTMLImageElement) => {\r\n    currentImageData = downsizeImageIfNeeded(image);\r\n    if (currentTexture !== null) {\r\n        currentTexture.uploadToGPU(currentImageData);\r\n    }\r\n});\r\n\r\nfunction getTexture(): ImageTexture {\r\n    if (currentTexture === null) {\r\n        currentTexture = new ImageTexture(currentImageData);\r\n    }\r\n\r\n    return currentTexture;\r\n}\r\n\r\nexport {\r\n    getTexture,\r\n};\r\n","import \"./page-interface-generated\";\r\n\r\n\r\nconst loadingObjects: { [id: string]: boolean } = {};\r\n\r\nfunction registerLoadingObject(id: string): void {\r\n    if (Object.keys(loadingObjects).length === 0) {\r\n        Page.Canvas.showLoader(true);\r\n    }\r\n    loadingObjects[id] = false;\r\n}\r\n\r\nfunction registerLoadedObject(id: string): void {\r\n    delete loadingObjects[id];\r\n\r\n    if (Object.keys(loadingObjects).length === 0) {\r\n        Page.Canvas.showLoader(false);\r\n    }\r\n}\r\n\r\nexport {\r\n    registerLoadedObject,\r\n    registerLoadingObject,\r\n};\r\n","import { Engine } from \"./engine\";\r\nimport * as FPSIndicator from \"./fps-indicator\";\r\n\r\nimport * as GLCanvas from \"./gl-utils/gl-canvas\";\r\nimport { gl } from \"./gl-utils/gl-canvas\";\r\n\r\nimport { Parameters } from \"./parameters\";\r\nimport { Visor } from \"./visor\";\r\n\r\nimport \"./page-interface-generated\";\r\n\r\n\r\nfunction main(): void {\r\n    const webglFlags = {\r\n        alpha: false,\r\n        antialias: false,\r\n        depth: false,\r\n        stencil: false,\r\n        preserveDrawingBuffer: false,\r\n    };\r\n    if (!GLCanvas.initGL(webglFlags)) {\r\n        return;\r\n    }\r\n    gl.disable(gl.CULL_FACE);\r\n    gl.disable(gl.BLEND);\r\n    gl.disable(gl.DEPTH_TEST);\r\n    gl.disable(gl.STENCIL_TEST);\r\n\r\n    const canvas = Page.Canvas.getCanvas();\r\n\r\n    Parameters.blurChangeObservers.push(() => { updateBlur(canvas); });\r\n    updateBlur(canvas);\r\n\r\n    let needToAdjustCanvasSize = true;\r\n    Parameters.canvasResizeObservers.push(() => { needToAdjustCanvasSize = true; });\r\n\r\n    let needToReset = true;\r\n    Parameters.resetObservers.push(() => { needToReset = true; });\r\n\r\n    let needToDownload = false;\r\n    Parameters.imageDownloadObservers.push(() => { needToDownload = true; });\r\n\r\n    const engine = new Engine();\r\n    const visor = new Visor();\r\n\r\n    function mainLoop(): void {\r\n        FPSIndicator.registerFrame();\r\n\r\n        if (needToDownload) {\r\n            // redraw before resizing the canvas because the download pane might open, which changes the canvas size\r\n            engine.drawToCanvas(); // redraw because preserveDrawingBuffer is false\r\n            download(canvas);\r\n            needToDownload = false;\r\n        }\r\n\r\n        if (needToAdjustCanvasSize) {\r\n            GLCanvas.adjustSize(false);\r\n            engine.resize(canvas.width, canvas.height);\r\n            needToAdjustCanvasSize = false;\r\n        }\r\n\r\n        if (needToReset) {\r\n            engine.reset();\r\n            needToReset = false;\r\n        }\r\n\r\n        engine.update();\r\n        engine.drawToCanvas();\r\n\r\n        visor.update();\r\n\r\n        if (Parameters.displayBrush) {\r\n            engine.displayBrush();\r\n        }\r\n\r\n        requestAnimationFrame(mainLoop);\r\n    }\r\n    mainLoop();\r\n}\r\n\r\nfunction updateBlur(canvas: HTMLElement): void {\r\n    const blur = Parameters.blur;\r\n    if (blur <= 0) {\r\n        canvas.style.filter = \"\";\r\n    } else {\r\n        canvas.style.filter = `blur(${blur}px)`;\r\n    }\r\n}\r\n\r\nfunction download(canvas: HTMLCanvasElement): void {\r\n    const name = \"reaction-diffusion.png\";\r\n\r\n    if ((canvas as any).msToBlob) { // for IE\r\n        const blob = (canvas as any).msToBlob();\r\n        window.navigator.msSaveBlob(blob, name);\r\n    } else {\r\n        canvas.toBlob((blob: Blob) => {\r\n            const link = document.createElement(\"a\");\r\n            link.download = name;\r\n            link.href = URL.createObjectURL(blob);\r\n            link.click();\r\n        });\r\n    }\r\n}\r\n\r\nmain();\r\n","import { EDisplayMode, EInitialState, EParametersMap, EShading } from \"./enums\";\r\nimport * as Loader from \"./loader\";\r\nimport { Presets } from \"./presets\";\r\n\r\nimport \"./page-interface-generated\";\r\n\r\n\r\n/* === IDs ============================================================ */\r\nconst controlId = {\r\n    PARAMETERS_MAP_TABS: \"map-tabs-id\",\r\n    PRESET_SELECT: \"presets-fixed-select-id\",\r\n    INPUT_IMAGE_UPLOAD: \"input-image-upload-button\",\r\n    PATTERNS_SCALE: \"pattern-scale-range-id\",\r\n    A_FEEDING_RANGE: \"A-feeding-range-id\",\r\n    A_DIFFUSION_RANGE: \"A-diffusion-range-id\",\r\n    B_KILLING_RANGE: \"B-killing-range-id\",\r\n    B_DIFFUSION_RANGE: \"B-diffusion-range-id\",\r\n    PICK_VALUES_BUTTON: \"pick-values-button-id\",\r\n\r\n    SPEED_RANGE: \"speed-range-id\",\r\n    BRUSH_SIZE_RANGE: \"brush-size-range-id\",\r\n    BRUSH_DISPLAY_CHECKBOX: \"brush-display-checkbox-id\",\r\n    INITIAL_STATE_TABS: \"initial-state-tabs-id\",\r\n    RESET_BUTTON: \"reset-button-id\",\r\n\r\n    DISPLAY_MODE_TABS: \"display-mode-tabs-id\",\r\n    SHADING_TABS: \"shading-tabs-id\",\r\n    ZOOM_RANGE: \"zoom-range-id\",\r\n    BLUR_RANGE: \"blur-range-id\",\r\n    INDICATORS_CHECKBOX: \"indicators-checkbox-id\",\r\n\r\n    IMAGE_DOWNLOAD: \"image-download-id\",\r\n};\r\n\r\ntype Observer = () => unknown;\r\ntype ImageUploadObserver = (image: HTMLImageElement) => unknown;\r\n\r\nfunction callObservers(observers: Observer[]): void {\r\n    for (const observer of observers) {\r\n        observer();\r\n    }\r\n}\r\n\r\nlet isInValuePickingMode = false;\r\n\r\nconst updateParametersVisibility = () => {\r\n    const map = Parameters.parametersMap;\r\n    const displayMode = Parameters.displayMode;\r\n    Page.Controls.setVisibility(controlId.PRESET_SELECT, map !== EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.A_FEEDING_RANGE, map !== EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.B_KILLING_RANGE, map !== EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.PICK_VALUES_BUTTON, map !== EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.PATTERNS_SCALE, map === EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.A_DIFFUSION_RANGE, map !== EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.B_DIFFUSION_RANGE, map !== EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.INPUT_IMAGE_UPLOAD, map === EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.DISPLAY_MODE_TABS, map === EParametersMap.IMAGE);\r\n    Page.Controls.setVisibility(controlId.SHADING_TABS, displayMode === EDisplayMode.MONOCHROME);\r\n};\r\n\r\nfunction clearPreset(): void {\r\n    Page.Select.setValue(controlId.PRESET_SELECT, null);\r\n}\r\nPage.Range.addObserver(controlId.A_FEEDING_RANGE, clearPreset);\r\nPage.Range.addObserver(controlId.A_DIFFUSION_RANGE, clearPreset);\r\nPage.Range.addObserver(controlId.B_KILLING_RANGE, clearPreset);\r\nPage.Range.addObserver(controlId.B_DIFFUSION_RANGE, clearPreset);\r\n// Page.Range.addObserver(controlId.SPEED_RANGE, clearPreset);\r\n// Page.Tabs.addObserver(controlId.INITIAL_STATE_TABS, clearPreset);\r\n// Page.Tabs.addObserver(controlId.SHADING_TABS, clearPreset);\r\n// Page.Range.addObserver(controlId.ZOOM_RANGE, clearPreset);\r\n\r\nabstract class Parameters {\r\n    public static readonly imageUploadObservers: ImageUploadObserver[] = [];\r\n    public static readonly imageDownloadObservers: Observer[] = [];\r\n    public static readonly canvasResizeObservers: Observer[] = [];\r\n    public static readonly resetObservers: Observer[] = [];\r\n    public static readonly blurChangeObservers: Observer[] = [];\r\n\r\n    public static get parametersMap(): EParametersMap {\r\n        if (isInValuePickingMode) {\r\n            return EParametersMap.VALUE_PICKING;\r\n        }\r\n        return Page.Tabs.getValues(controlId.PARAMETERS_MAP_TABS)[0] as EParametersMap;\r\n    }\r\n    public static exitValuePickingMode(): void {\r\n        isInValuePickingMode = false;\r\n        Page.Tabs.setValues(controlId.PARAMETERS_MAP_TABS, [EParametersMap.UNIFORM]);\r\n        updateParametersVisibility();\r\n    }\r\n\r\n    public static get patternsScale(): number {\r\n        return Page.Range.getValue(controlId.PATTERNS_SCALE);\r\n    }\r\n    public static get AFeedingRate(): number {\r\n        return Page.Range.getValue(controlId.A_FEEDING_RANGE);\r\n    }\r\n    public static set AFeedingRate(value: number) {\r\n        Page.Range.setValue(controlId.A_FEEDING_RANGE, value);\r\n        Page.Range.storeState(controlId.A_FEEDING_RANGE);\r\n        clearPreset();\r\n    }\r\n    public static get ADiffusionRate(): number {\r\n        return Page.Range.getValue(controlId.A_DIFFUSION_RANGE);\r\n    }\r\n    public static get BKillingRate(): number {\r\n        return Page.Range.getValue(controlId.B_KILLING_RANGE);\r\n    }\r\n    public static set BKillingRate(value: number) {\r\n        Page.Range.setValue(controlId.B_KILLING_RANGE, value);\r\n        Page.Range.storeState(controlId.B_KILLING_RANGE);\r\n        clearPreset();\r\n    }\r\n    public static get BDIffusionRate(): number {\r\n        return Page.Range.getValue(controlId.B_DIFFUSION_RANGE);\r\n    }\r\n\r\n    public static get speed(): number {\r\n        return Page.Range.getValue(controlId.SPEED_RANGE);\r\n    }\r\n    public static get brushSize(): number {\r\n        return Page.Range.getValue(controlId.BRUSH_SIZE_RANGE);\r\n    }\r\n    public static get displayBrush(): boolean {\r\n        return !isInValuePickingMode && Page.Checkbox.isChecked(controlId.BRUSH_DISPLAY_CHECKBOX);\r\n    }\r\n    public static get initialState(): EInitialState {\r\n        if (isInValuePickingMode) {\r\n            return EInitialState.CIRCLE;\r\n        }\r\n        return Page.Tabs.getValues(controlId.INITIAL_STATE_TABS)[0] as EInitialState;\r\n    }\r\n\r\n    public static get zoom(): number {\r\n        return Page.Range.getValue(controlId.ZOOM_RANGE);\r\n    }\r\n    public static get blur(): number {\r\n        return Page.Range.getValue(controlId.BLUR_RANGE);\r\n    }\r\n\r\n    public static get displayMode(): EDisplayMode {\r\n        if (Parameters.parametersMap === EParametersMap.IMAGE) {\r\n            return Page.Tabs.getValues(controlId.DISPLAY_MODE_TABS)[0] as EDisplayMode;\r\n        } else {\r\n            return EDisplayMode.MONOCHROME;\r\n        }\r\n    }\r\n\r\n    public static get shading(): EShading {\r\n        return Page.Tabs.getValues(controlId.SHADING_TABS)[0] as EShading;\r\n    }\r\n}\r\n\r\nconst callCanvasResizeObservers = () => { callObservers(Parameters.canvasResizeObservers); };\r\nPage.Canvas.Observers.canvasResize.push(callCanvasResizeObservers);\r\n\r\nconst callResetObservers = () => { callObservers(Parameters.resetObservers); };\r\nPage.Select.addObserver(controlId.PRESET_SELECT, callResetObservers);\r\nPage.Button.addObserver(controlId.RESET_BUTTON, callResetObservers);\r\nPage.Tabs.addObserver(controlId.PARAMETERS_MAP_TABS, callResetObservers);\r\nPage.Tabs.addObserver(controlId.DISPLAY_MODE_TABS, callResetObservers);\r\nPage.Tabs.addObserver(controlId.INITIAL_STATE_TABS, callResetObservers);\r\nParameters.imageUploadObservers.push(callResetObservers);\r\n\r\nPage.Tabs.addObserver(controlId.PARAMETERS_MAP_TABS, () => {\r\n    isInValuePickingMode = false;\r\n    updateParametersVisibility();\r\n\r\n    if (Parameters.parametersMap === EParametersMap.IMAGE) {\r\n        Page.Range.setValue(controlId.ZOOM_RANGE, 1);\r\n        Page.Range.setValue(controlId.SPEED_RANGE, 40);\r\n        Page.Tabs.setValues(controlId.INITIAL_STATE_TABS, [EInitialState.CIRCLE]);\r\n        Page.Tabs.setValues(controlId.SHADING_TABS, [EShading.BINARY]);\r\n\r\n        Page.Range.clearStoredState(controlId.ZOOM_RANGE);\r\n        Page.Range.clearStoredState(controlId.SPEED_RANGE);\r\n        Page.Tabs.clearStoredState(controlId.INITIAL_STATE_TABS);\r\n        Page.Tabs.clearStoredState(controlId.SHADING_TABS);\r\n        Page.Select.clearStoredState(controlId.PRESET_SELECT);\r\n    }\r\n});\r\nPage.Tabs.addObserver(controlId.DISPLAY_MODE_TABS, updateParametersVisibility);\r\nupdateParametersVisibility();\r\n\r\nconst updateIndicatorsVisibility = () => {\r\n    Page.Canvas.setIndicatorsVisibility(Page.Checkbox.isChecked(controlId.INDICATORS_CHECKBOX));\r\n};\r\nPage.Checkbox.addObserver(controlId.INDICATORS_CHECKBOX, updateIndicatorsVisibility);\r\nupdateIndicatorsVisibility();\r\n\r\nPage.Button.addObserver(controlId.PICK_VALUES_BUTTON, () => {\r\n    Page.Tabs.setValues(controlId.PARAMETERS_MAP_TABS, []);\r\n    isInValuePickingMode = true;\r\n    Page.Range.setValue(controlId.A_DIFFUSION_RANGE, 0.2097);\r\n    Page.Range.setValue(controlId.B_DIFFUSION_RANGE, 0.1050);\r\n    Page.Range.setValue(controlId.ZOOM_RANGE, 1);\r\n    if (Parameters.speed < 30) {\r\n        Page.Range.setValue(controlId.SPEED_RANGE, 30);\r\n    }\r\n    clearPreset();\r\n\r\n    updateParametersVisibility();\r\n    callResetObservers();\r\n});\r\n\r\nPage.Range.addObserver(controlId.BLUR_RANGE, () => {\r\n    callObservers(Parameters.blurChangeObservers);\r\n});\r\n\r\nPage.FileControl.addUploadObserver(controlId.INPUT_IMAGE_UPLOAD, (filesList: FileList) => {\r\n    if (filesList.length === 1) {\r\n        const reader = new FileReader();\r\n        reader.onload = () => {\r\n            const image = new Image();\r\n            image.addEventListener(\"load\", () => {\r\n                for (const observer of Parameters.imageUploadObservers) {\r\n                    observer(image);\r\n                }\r\n            });\r\n            image.src = reader.result as string;\r\n        };\r\n        reader.readAsDataURL(filesList[0]);\r\n    }\r\n});\r\n{\r\n    const url = `./resources/cat.jpg?v=${Page.version}`;\r\n    Loader.registerLoadingObject(url);\r\n\r\n    const defaultImage = new Image();\r\n    defaultImage.addEventListener(\"load\", () => {\r\n        Loader.registerLoadedObject(url);\r\n\r\n        for (const observer of Parameters.imageUploadObservers) {\r\n            observer(defaultImage);\r\n        }\r\n    });\r\n    defaultImage.src = url;\r\n}\r\n\r\nPage.FileControl.addDownloadObserver(controlId.IMAGE_DOWNLOAD, () => {\r\n    callObservers(Parameters.imageDownloadObservers);\r\n});\r\n\r\nfunction applyCurrentPreset(): void {\r\n    if (Parameters.parametersMap === EParametersMap.UNIFORM) {\r\n        const selectedPresetId = Page.Select.getValue(controlId.PRESET_SELECT);\r\n        const preset = Presets[selectedPresetId];\r\n        if (preset) {\r\n            Page.Range.setValue(controlId.A_FEEDING_RANGE, preset.aFeeding);\r\n            Page.Range.setValue(controlId.A_DIFFUSION_RANGE, preset.aDiffuse);\r\n            Page.Range.setValue(controlId.B_KILLING_RANGE, preset.bKilling);\r\n            Page.Range.setValue(controlId.B_DIFFUSION_RANGE, preset.bDiffuse);\r\n            Page.Range.setValue(controlId.SPEED_RANGE, preset.speed);\r\n            Page.Range.setValue(controlId.ZOOM_RANGE, preset.zoom);\r\n            Page.Tabs.setValues(controlId.INITIAL_STATE_TABS, [preset.initialState]);\r\n            Page.Tabs.setValues(controlId.SHADING_TABS, [preset.shading]);\r\n\r\n            Page.Range.clearStoredState(controlId.A_FEEDING_RANGE);\r\n            Page.Range.clearStoredState(controlId.A_DIFFUSION_RANGE);\r\n            Page.Range.clearStoredState(controlId.B_KILLING_RANGE);\r\n            Page.Range.clearStoredState(controlId.B_DIFFUSION_RANGE);\r\n            Page.Range.clearStoredState(controlId.SPEED_RANGE);\r\n            Page.Range.clearStoredState(controlId.ZOOM_RANGE);\r\n            Page.Tabs.clearStoredState(controlId.INITIAL_STATE_TABS);\r\n            Page.Tabs.clearStoredState(controlId.SHADING_TABS);\r\n        }\r\n    }\r\n}\r\nPage.Select.addObserver(controlId.PRESET_SELECT, () => {\r\n    Parameters.exitValuePickingMode();\r\n    applyCurrentPreset();\r\n});\r\nPage.Tabs.addObserver(controlId.PARAMETERS_MAP_TABS, applyCurrentPreset);\r\napplyCurrentPreset();\r\n\r\n// add fake observer to prevent touch events from moving viewport on touch devices\r\nPage.Canvas.Observers.mouseDrag.push(() => { }); /* tslint:disable-line:no-empty */\r\n\r\nexport {\r\n    Parameters,\r\n};\r\n","import { EInitialState, EShading } from \"./enums\";\r\n\r\ninterface IPreset {\r\n    aFeeding: number;\r\n    aDiffuse: number;\r\n    bKilling: number;\r\n    bDiffuse: number;\r\n    speed: number;\r\n    zoom: number;\r\n    initialState: EInitialState;\r\n    shading: EShading;\r\n}\r\n\r\nconst presets: { [id: string]: IPreset } = {\r\n    \"0\": { // tiny waves\r\n        aFeeding: 0.015,\r\n        aDiffuse: 0.210,\r\n        bKilling: 0.049,\r\n        bDiffuse: 0.105,\r\n        speed: 8,\r\n        zoom: 3,\r\n        initialState: EInitialState.DISC,\r\n        shading: EShading.COLORSCALE,\r\n    },\r\n    \"1\": { // lines\r\n        aFeeding: 0.037,\r\n        aDiffuse: 0.500,\r\n        bKilling: 0.059,\r\n        bDiffuse: 0.342,\r\n        speed: 100,\r\n        zoom: 1,\r\n        initialState: EInitialState.CIRCLE,\r\n        shading: EShading.BINARY,\r\n    },\r\n    \"2\": { // orthogonal\r\n        aFeeding: 0.058,\r\n        aDiffuse: 0.210,\r\n        bKilling: 0.063,\r\n        bDiffuse: 0.105,\r\n        speed: 60,\r\n        zoom: 1,\r\n        initialState: EInitialState.CIRCLE,\r\n        shading: EShading.GREYSCALE,\r\n    },\r\n    \"3\": { // shimmer\r\n        aFeeding: 0.021,\r\n        aDiffuse: 0.210,\r\n        bKilling: 0.056,\r\n        bDiffuse: 0.105,\r\n        speed: 10,\r\n        zoom: 2,\r\n        initialState: EInitialState.CIRCLE,\r\n        shading: EShading.COLORSCALE,\r\n    },\r\n    \"4\": { // geometric\r\n        aFeeding: 0.049,\r\n        aDiffuse: 0.210,\r\n        bKilling: 0.061,\r\n        bDiffuse: 0.105,\r\n        speed: 40,\r\n        zoom: 1,\r\n        initialState: EInitialState.CIRCLE,\r\n        shading: EShading.GREYSCALE,\r\n    },\r\n    \"5\": { // holes\r\n        aFeeding: 0.041,\r\n        aDiffuse: 0.210,\r\n        bKilling: 0.059,\r\n        bDiffuse: 0.130,\r\n        speed: 80,\r\n        zoom: 1,\r\n        initialState: EInitialState.DISC,\r\n        shading: EShading.COLORSCALE,\r\n    },\r\n    \"6\": { // epilepsy\r\n        aFeeding: 0.022,\r\n        aDiffuse: 0.210,\r\n        bKilling: 0.049,\r\n        bDiffuse: 0.105,\r\n        speed: 10,\r\n        zoom: 1,\r\n        initialState: EInitialState.CIRCLE,\r\n        shading: EShading.GREYSCALE,\r\n    },\r\n};\r\n\r\nexport {\r\n    IPreset,\r\n    presets as Presets,\r\n};\r\n","import { gl } from \"../gl-utils/gl-canvas\";\r\nimport * as Loader from \"../loader\";\r\n\r\nfunction buildDefaultImageData(): ImageData {\r\n    const v = 0;\r\n\r\n    try {\r\n        return new ImageData(new Uint8ClampedArray([v, v, v, v]), 1, 1);\r\n    } catch {\r\n        console.log(\"Failed to create default ImageData from constructor, using Canvas2D instead...\");\r\n\r\n        const hiddenCanvas = document.createElement(\"canvas\");\r\n        const context = hiddenCanvas.getContext(\"2d\");\r\n        const result = context.createImageData(1, 1);\r\n        for (let i = 0; i < result.data.length; i++) {\r\n            result.data[i] = v;\r\n        }\r\n        return result;\r\n    }\r\n}\r\n\r\nconst defaultImageData = buildDefaultImageData();\r\n\r\nclass ImageTexture {\r\n    public readonly id: WebGLTexture;\r\n    private _width: number = -1;\r\n    private _height: number = -1;\r\n\r\n    public constructor(image?: ImageData) {\r\n        this.id = gl.createTexture();\r\n\r\n        this.uploadToGPU(image ?? defaultImageData);\r\n    }\r\n\r\n    public loadFromUrl(url: string): void {\r\n        url = `${url}?v=${Page.version}`;\r\n\r\n        Loader.registerLoadingObject(url);\r\n\r\n        const rampImage = new Image();\r\n        rampImage.addEventListener(\"load\", () => {\r\n            Loader.registerLoadedObject(url);\r\n            this.uploadToGPU(rampImage);\r\n        });\r\n\r\n        rampImage.src = url;\r\n    }\r\n\r\n    public uploadToGPU(image: HTMLImageElement | ImageData): void {\r\n        this._width = image.width;\r\n        this._height = image.height;\r\n\r\n        gl.bindTexture(gl.TEXTURE_2D, this.id);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n        gl.bindTexture(gl.TEXTURE_2D, null);\r\n    }\r\n\r\n    public get width(): number {\r\n        return this._width;\r\n    }\r\n    public get height(): number {\r\n        return this._height;\r\n    }\r\n}\r\n\r\nexport {\r\n    ImageTexture,\r\n};\r\n","import { RenderToTexture } from \"./render-to-texture\";\r\n\r\n\r\nclass RenderToTextureSwapable {\r\n    private previousTexture: RenderToTexture;\r\n    private currentTexture: RenderToTexture;\r\n\r\n    public constructor() {\r\n        this.previousTexture = new RenderToTexture();\r\n        this.currentTexture = new RenderToTexture();\r\n    }\r\n\r\n    public get previous(): WebGLTexture {\r\n        return this.previousTexture.texture;\r\n    }\r\n    public get current(): WebGLTexture {\r\n        return this.currentTexture.texture;\r\n    }\r\n    public get currentFramebuffer(): WebGLFramebuffer {\r\n        return this.currentTexture.framebuffer;\r\n    }\r\n\r\n    public get width(): number {\r\n        return this.previousTexture.width;\r\n    }\r\n    public get height(): number {\r\n        return this.previousTexture.height;\r\n    }\r\n\r\n\r\n    public reserveSpace(width: number, height: number): void {\r\n        this.previousTexture.reserveSpace(width, height);\r\n        this.currentTexture.reserveSpace(width, height);\r\n    }\r\n\r\n    public swap(): void {\r\n        const tmp = this.currentTexture;\r\n        this.currentTexture = this.previousTexture;\r\n        this.previousTexture = tmp;\r\n    }\r\n}\r\n\r\nexport {\r\n    RenderToTextureSwapable,\r\n};\r\n","import { gl } from \"../gl-utils/gl-canvas\";\r\n\r\n\r\nclass RenderToTexture {\r\n    public readonly texture: WebGLTexture;\r\n    public readonly framebuffer: WebGLFramebuffer;\r\n    private _width: number;\r\n    private _height: number;\r\n\r\n    public constructor() {\r\n        this.texture = gl.createTexture();\r\n        this.framebuffer = gl.createFramebuffer();\r\n        this._width = -1;\r\n        this._height = -1;\r\n    }\r\n\r\n    public reserveSpace(wantedWidth: number, wantedHeight: number): void {\r\n        wantedWidth = Math.ceil(wantedWidth);\r\n        wantedHeight = Math.ceil(wantedHeight);\r\n\r\n        if (this.width !== wantedWidth || this.height !== wantedHeight) {\r\n            gl.bindTexture(gl.TEXTURE_2D, this.texture);\r\n\r\n            const format = gl.RGBA;\r\n            gl.texImage2D(gl.TEXTURE_2D, 0, format, wantedWidth, wantedHeight, 0, format, gl.UNSIGNED_BYTE, null);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, this.framebuffer);\r\n            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, this.texture, 0);\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n\r\n            gl.bindTexture(gl.TEXTURE_2D, null);\r\n\r\n            this._width = wantedWidth;\r\n            this._height = wantedHeight;\r\n        }\r\n    }\r\n\r\n    public get width(): number {\r\n        return this._width;\r\n    }\r\n\r\n    public get height(): number {\r\n        return this._height;\r\n    }\r\n}\r\n\r\nexport {\r\n    RenderToTexture,\r\n};\r\n","import { Engine } from \"./engine\";\r\nimport { EParametersMap } from \"./enums\";\r\nimport { Parameters } from \"./parameters\";\r\n\r\nimport \"./page-interface-generated\";\r\n\r\n\r\nenum EBarDirection {\r\n    HORIZONTAL = \"horizontal\",\r\n    VERTICAL = \"vertical\",\r\n}\r\n\r\ninterface IBar {\r\n    container: HTMLElement;\r\n    legendContainer: HTMLElement;\r\n    legendValue: HTMLSpanElement;\r\n}\r\n\r\nclass Visor {\r\n    private readonly horizontalLine: IBar;\r\n    private readonly verticalLine: IBar;\r\n\r\n    public constructor() {\r\n        const container = Page.Canvas.getCanvasContainer();\r\n\r\n        this.horizontalLine = Visor.createBar(EBarDirection.HORIZONTAL, \"B killing rate\");\r\n        container.appendChild(this.horizontalLine.container);\r\n\r\n        this.verticalLine = Visor.createBar(EBarDirection.VERTICAL, \"A feeding rate\");\r\n        container.appendChild(this.verticalLine.container);\r\n\r\n        Page.Canvas.getCanvas().addEventListener(\"click\", () => {\r\n            if (Parameters.parametersMap === EParametersMap.VALUE_PICKING) {\r\n                const currentPos = Page.Canvas.getMousePosition();\r\n                Parameters.AFeedingRate = Visor.aimedFeedA(currentPos);\r\n                Parameters.BKillingRate = Visor.aimedKillB(currentPos);\r\n                Parameters.exitValuePickingMode();\r\n            }\r\n        });\r\n    }\r\n\r\n    public update(): void {\r\n        const mousePosition = Page.Canvas.getMousePosition();\r\n        const isVisible = (Parameters.parametersMap === EParametersMap.VALUE_PICKING) && Visor.isInRange(0, 1, mousePosition[0]) && Visor.isInRange(0, 1, mousePosition[1]);\r\n\r\n        if (isVisible) {\r\n            this.horizontalLine.legendValue.textContent = Visor.toString(Visor.aimedKillB(mousePosition), 5);\r\n            this.verticalLine.legendValue.textContent = Visor.toString(Visor.aimedFeedA(mousePosition), 5);\r\n\r\n            const canvasSize = Page.Canvas.getSize();\r\n            const hPixel = Math.round(mousePosition[0] * canvasSize[0]);\r\n            const vPixel = Math.round(mousePosition[1] * canvasSize[1]);\r\n            this.horizontalLine.container.style.left = `${hPixel}px`;\r\n            {\r\n                const legendBox = this.horizontalLine.legendContainer.getBoundingClientRect();\r\n                const size = legendBox.width;\r\n                if (hPixel - 0.5 * size < 0) {\r\n                    this.horizontalLine.legendContainer.style.left = `${0.5 * size - hPixel}px`;\r\n                } else if (hPixel + 0.5 * size > canvasSize[0]) {\r\n                    this.horizontalLine.legendContainer.style.left = `${canvasSize[0] - (hPixel + 0.5 * size)}px`;\r\n                } else {\r\n                    this.horizontalLine.legendContainer.style.left = \"\";\r\n                }\r\n            }\r\n\r\n            this.verticalLine.container.style.top = `${vPixel}px`;\r\n            {\r\n                const legendBox = this.verticalLine.legendContainer.getBoundingClientRect();\r\n                const size = legendBox.height;\r\n                if (vPixel - 0.5 * size < 0) {\r\n                    this.verticalLine.legendContainer.style.top = `${0.5 * size - vPixel}px`;\r\n                } else if (vPixel + 0.5 * size > canvasSize[1]) {\r\n                    this.verticalLine.legendContainer.style.top = `${canvasSize[1] - (vPixel + 0.5 * size)}px`;\r\n                } else {\r\n                    this.verticalLine.legendContainer.style.top = \"\";\r\n                }\r\n            }\r\n        }\r\n\r\n        const display = isVisible ? \"\" : \"none\";\r\n        this.horizontalLine.container.style.display = display;\r\n        this.verticalLine.container.style.display = display;\r\n    }\r\n\r\n    private static aimedFeedA(mousePos: number[]): number {\r\n        const y = Visor.clamp(0, 1, 1 - mousePos[1]);\r\n        const adjustedY = 0.5 + (y - 0.5) / Parameters.zoom;\r\n        return Visor.interpolate(Engine.A_FEEDING_MIN, Engine.A_FEEDING_MAX, adjustedY);\r\n    }\r\n\r\n    private static aimedKillB(mousePos: number[]): number {\r\n        const x = Visor.clamp(0, 1, mousePos[0]);\r\n        const adjustedX = 0.5 + (x - 0.5) / Parameters.zoom;\r\n        return Visor.interpolate(Engine.B_KILLING_MIN, Engine.B_KILLING_MAX, adjustedX);\r\n    }\r\n\r\n    private static createBar(direction: EBarDirection, label: string): IBar {\r\n        const container = document.createElement(\"div\");\r\n        container.classList.add(\"visor-bar\");\r\n        container.classList.add(direction);\r\n        container.style.display = \"none\";\r\n\r\n        const legendContainer = document.createElement(\"div\");\r\n        legendContainer.classList.add(\"visor-bar-legend\");\r\n\r\n        const labelElement = document.createElement(\"span\");\r\n        labelElement.textContent = label;\r\n        legendContainer.appendChild(labelElement);\r\n        legendContainer.appendChild(document.createElement(\"br\"));\r\n        const legendValue = document.createElement(\"span\");\r\n        legendValue.textContent = \"?\";\r\n        legendContainer.appendChild(legendValue);\r\n\r\n        container.appendChild(legendContainer);\r\n\r\n        return {\r\n            container,\r\n            legendContainer,\r\n            legendValue,\r\n        };\r\n    }\r\n\r\n    private static clamp(min: number, max: number, x: number): number {\r\n        if (x < min) return min;\r\n        if (x > max) return max;\r\n        return x;\r\n    }\r\n\r\n    private static interpolate(a: number, b: number, x: number): number {\r\n        return b * x + a * (1 - x);\r\n    }\r\n\r\n    private static isInRange(min: number, max: number, x: number): boolean {\r\n        return min <= x && x <= max;\r\n    }\r\n\r\n    private static toString(x: number, maxDigits: number): string {\r\n        const raw = x.toString();\r\n        const dotIndex = raw.indexOf(\".\");\r\n        if (dotIndex < 0) {\r\n            return raw;\r\n        } else {\r\n            const nbDigits = Math.min(maxDigits, raw.length - (dotIndex + 1));\r\n            return raw.substring(0, dotIndex + 1 + nbDigits);\r\n        }\r\n    }\r\n}\r\n\r\nexport {\r\n    Visor,\r\n};\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(633);\n"],"sourceRoot":""}